<html>
<body>

<div id="css">
<style type='text/css'>
	body {color: Black; 
			font-size:100%;
			font-weight: bold;

			text-shadow: 0px 0px 2px #FFF,0px 0px 2px #FFF, 0px 1px 1px #FFF, 0px 2px 1px #FFF, 0px 3px 2px #777 ;
			/*font-family:impact;
			font-family:Tahoma;
			font-family: georgia;
			*/
			 font-family: courier;
			}
	button {
						text-align: center;
						color: Black; 
						font-size:100%;
						font-weight: bold;

						text-shadow: 0px 0px 2px #FFF,0px 0px 2px #FFF, 0px 1px 1px #FFF, 0px 2px 1px #FFF, 0px 3px 2px #777 ;
						/*font-family:impact;
						font-family:Tahoma;
						font-family: georgia;
						*/
						 font-family: courier;
						 
						 border-top-left-radius: 20px;
						border-top-right-radius: 20px;
						border-bottom-left-radius: 20px;
						border-bottom-right-radius: 1px;
					}
			
			button:hover
			{
				Background-color: #CCCCCC; 
				color: #404040; 
			}
			button:active
			{
				Background-color: #999999; 
				color: #000000; 
			}
	.bigbutton {
		font-size:200%;
	}
	textarea {
		padding: 12px;
		width:75%;
		min-height: 200px;
		max-height: 300px;
	}


	#Intro_header {
		text-align: center;
		color: black;
		font-size:150%;
		text-shadow: 0px 1px 0px #999, -2px 2px 0px #FFF,-2px -2px 0px #FFF, 2px 2px 0px #FFF, 4px 4px 0px #000;
		font-family: courier;
		font-weight: bold;
	}
	/* unused */
	#body_Div {
		margin: 0 auto;
		min-width: 300px;
		max-width: 500px;
	}
	textArea {
		border-top-left-radius: 20px;
		border-top-right-radius: 20px;
		border-bottom-left-radius: 20px;
		border-bottom-right-radius: 20px;
	}
	input {
		border-top-left-radius: 20px;
		border-top-right-radius: 20px;
		border-bottom-left-radius: 20px;
		border-bottom-right-radius: 20px;
	}
	#buttonInputClick {
		overflow-y: scroll; 
		position: relative;  
		width:20%;
	}
	#cRecordInput {
		overflow-y: scroll; 
		position: relative;  
		width:70%;
	}
	.display {
		overflow-y: scroll;
		position: relative;
		height:50%; 
		width:90%;
		left:5%;
		
		border-top-style: dotted;
		border-right-style: solid;
		border-bottom-style: dotted;
		border-left-style: solid;
	}
	#cSaveBox {
		overflow-y: scroll; 
		position: relative; 
		height:50%; 
		width:90%;
	}
	
</style>
</div>
<center>
<h1>&#9830; Chat Recorder &#9830; </h1>
</center>
<div id="record_container">
	<center>
	<button class='bigbutton' onclick="c.main(c.CMD['START_PLAYBACK']); c.HideShow(['record_container','saveBox'],['playback_container','playbackBackButton']);"> Test It Out!</button>
	<button class='bigbutton'  onclick="c.main(c.CMD['SAVE_FILE']); c.HideShow(['playback_container','record_container'],['saveBox']);"> Save It! </button>
	</center>
	<div id="cRecord" class='display'> </div>
	
	<center>
			<button id='buttonInputClick' onclick="c.main(c.CMD['ADD_TEXT']);">&#10146; Add text (ENTER) </button>
			<input id="cRecordInput" ></input>
		
		
		<br>
		<button onclick="c.main(c.CMD['MARK_SKIP_CLICKING_STARTING_NOW'])"> Add /clickskips</button>
		<button onclick="c.main(c.CMD['ADD_FASTER'])"> Add /realfast</button>
		<button onclick="c.main(c.CMD['ADD_FAST'])"> Add /fast</button>
		<button onclick="c.main(c.CMD['ADD_NEEDSCLICK'])"> Add /needsclick</button>
		<button onclick="c.main(c.CMD['MARK_WAKEUP_SCRIPT']);"> Add /wakeupscript </button>
		<br><br>
		<button class='bigbutton'  onclick="c.main(c.CMD['CLEAR_RECORDING']);"> Start From scratch </button>
		<hr>
		<h2> HOW TO USE:</h2>
		<br>
		Simply type in the box above and press enter as if in a chatroom.
		The time interval will be recorded and played back at the same speed.
		<br><br>
		Additional commands: (can be used by typing them in)
		<br>
		All the above buttons with a '/' next to them can be typed in.
		(as well as '' for italics and '' '' for bold text.)
		<br>/faster makes the playback run at very fast speed.
		<br>/fast makes the playback run at 2X speed
		<br>/needsclick will pause the playback and wait for a click. 
		<br>/wakeupscript will scroll down to the wakeup script when the 
			'wakeup script' button is pressed. 
		<br>/clickskips will make pressing the button in playback skip 
			to the next line that does not contain /clickskip.
		<br><br>
		/clickskips, /fast, and /faster will stay in the input box until deleted. 
		<hr>
		Once done, click on the 'save it' button and copy the text in 
		the text box to a text file (have the filename end in '.html').
		<br>This will be a recording of what was typed.
	</center>
</div>
<!-- convert this one to innerHTML and put on final page-->
<div id="playback_container" hidden=false > 
	<center>
	<button class='bigbutton'  id='playbackBackButton' hidden=true; onclick="c.HideShow(['playback_container','saveBox'],['record_container']);" > &#8656; Show Recording Page</button>
	</center>
	<div id="cPlayback" class='display' > </div>
	<center>
	<button class='bigbutton' onclick="c.main(c.CMD['PLAYBACK_PRESS_BUTTON']);"> Press Button (W)</button>
	<button class='bigbutton' onclick="c.main(c.CMD['PLAYBACK_GOTO_WAKUP_SCRIPT']);"> Wake Up Script (Q) </button>
	<br><br>
	<button class='bigbutton' onclick="c.main(c.CMD['START_PLAYBACK'])"> Start/Restart Playback</button>
	<br><br>
	Click on the 'start/restart' playback button to start!
	</center>
</div>
<!-- convert this one to innerHTML and put on final page-->
<div id="saveBox" hidden=true > 
	<center>
	<button class='bigbutton'  onclick="c.main(c.CMD['SAVE_FILE']); c.HideShow(['playback_container','saveBox'],['record_container']);"> &#8656; Back To Record </button>
	<br>
	<textarea id="cSaveBox" onclick="this.select()" readOnly='true'> </textarea>
	
	<br>
	<hr>
	&#10003; Save the above text to a html file. (click, copy, past to text file, rename the file extension .html)  &#10003;
	
	</center>
</div>

<script language='javascript'>
	
	//c = core
	c = {};
	c.playbackHTML_div_Caught = "";
	
	c.HideShow = function(hideList, showlist){ //list of element IDs
		for(i in hideList){ 
			document.getElementById(hideList[i]).hidden = true;}
		for(i in showlist){ 
			document.getElementById(showlist[i]).hidden = false;} }
	c.data_DEFAULT = {
		time:0,
		timeMultiplier :1,
		place:0,
		running:true,
		commands:[ 
		//" ::125",
		//" ::234"
		]};
	c.data =JSON.parse( JSON.stringify(c.data_DEFAULT)); 
	c.dataPlayback =JSON.parse( JSON.stringify(c.data_DEFAULT));  
	c.dataPlayback.running = false;
	c.dataPlayback_Caught = JSON.parse( JSON.stringify(c.data_DEFAULT));
	
	c.formatAllBlocksWith = ["<div>","</div>"]
	c.formatCommands ={ 
		"/fast":"/fast", "/realfast":"/realfast",  
		"/clickskips":"/clickskips", "/wakeupscript":"/wakeupscript",
		"/needsclick":"/needsclick"
	};
	c.speeds ={"/fast":2, "/realfast":30};
	c.keepTextBetweenBlocks ={ 
		"/fast":"/fast", "/realfast":"/realfast", "/clickskips":"/clickskips" };
	
	c.formatString_TextByStyle = {
		"''":['<font size="5">','</font>'], "'":['<i>','</i>']
	}
	c.formatString_SingleBlocks = {
		":)":" ( :O ) ", ":/" : " : / ", "/hr": "<hr>"
	}
	c.formatString_FullStringByTextCmd = {
		"/left":["<div align='left'>","</div>"], 
		"/center":["<div align='center'>","</div>"],
		"/right":["<div align='right'>","</div>"],
	}
	c.styleData = function(s){
		s = s.split( c.TIME_BLOCK )[0];
		for(i in c.formatString_TextByStyle){
			while(s.split(i).length > 2){
				s = s.split(i);
				s = s[0]+
					c.formatString_TextByStyle[i][0] +
					s[1]+
					c.formatString_TextByStyle[i][1] + 
					s.slice(2,s.length).join(i);
		}	}		
		for(i in c.formatString_FullStringByTextCmd){
			if(s.split(i).length > 1){
				s = c.formatString_FullStringByTextCmd[i][0] +
						s.split(i).join("")+
					c.formatString_FullStringByTextCmd[i][1];
		}	}
		for(i in c.formatString_SingleBlocks){
			while(s.split(i).length > 1){
				s = s.split(i).join( c.formatString_SingleBlocks[i]);
		}	}
		for(i in c.formatCommands){ s = s.split(i).join("");}
		return c.formatAllBlocksWith[0] + s.trim() + c.formatAllBlocksWith[1];
	}
	//used as updateTextBlock(div.innerHTML, endBlock
	c.TEXT_DIV_DIVIDER = "<!---DIVIDE--->";
	c.updateTextBlock = function( s, list){
		var textInList = s.split(c.TEXT_DIV_DIVIDER);
		if(textInList.length > list.length){
			textInList = textInList.splice(0,list.length-1);
			return c.updateTextBlock(
				textInList.join(c.TEXT_DIV_DIVIDER),list );
		}else{
			for(i = textInList.length-1; i< list.length; i+=1){
				
				textInList.push(c.styleData(list[i]));
		}	}
		return textInList.join(c.TEXT_DIV_DIVIDER);
	}
	
	//unsaved for new page
	c.divDisp = document.getElementById('cRecord'); // should be an element
	//c.divPlayback = document.getElementById('cPlayback');
	c.divInputBox = document.getElementById('cRecordInput');// should be an element
	c.divSavedHTML = document.getElementById('cSaveBox');// should be an element (textArea)
	c.playbackHTML_div_Caught = 
		document.getElementById('playback_container').innerHTML + "";
	//saved
	c.settup_controls = function(){
		c.divPlayback = document.getElementById('cPlayback');// should be an element
		
		onkeypress = function(k){ 
			if(k.keyCode == 13){ c.main(c.CMD["ADD_TEXT"]);} //enter
			if(k.charCode == 119){ c.main(c.CMD["PLAYBACK_PRESS_BUTTON"]);} //w
			if(k.charCode == 113){ c.main(c.CMD["PLAYBACK_GOTO_WAKUP_SCRIPT"]);} }//q 
		setInterval( function(){ c.main(c.CMD['UPDATE_TIMER']);}, 20);
	}
	c.settup_controls();
	// control buttons with onclick EG:onclick="console.log(c.CMD); c.main('');"
	c.CMD = {"ADD_TEXT":"ADD_TEXT", "ADD_FAST":"ADD_FAST", 
			"ADD_NEEDSCLICK":"ADD_NEEDSCLICK",
			"ADD_FASTER":"ADD_FASTER", 
			"MARK_SKIP_CLICKING_STARTING_NOW":"MARK_SKIP_CLICKING_STARTING_NOW", 
			"MARK_WAKEUP_SCRIPT":"MARK_WAKEUP_SCRIPT",
			"CLEAR_RECORDING":"CLEAR_RECORDING",
			
			"PLAYBACK_GOTO_WAKUP_SCRIPT":"PLAYBACK_GOTO_WAKUP_SCRIPT", 
			"PLAYBACK_PRESS_BUTTON":"PLAYBACK_PRESS_BUTTON",
			"PLAYBACK_RESET":"PLAYBACK_RESET",
			
			"UPDATE_TIMER":"UPDATE_TIMER",
			
			"UPDATE_PLAYBACK_TEXT": "UPDATE_PLAYBACK_TEXT",
			"UPDATE_DISP_TEXT": "UPDATE_DISP_TEXT",
			"START_PLAYBACK": "START_PLAYBACK",
			
			"SAVE_FILE":"SAVE_FILE"}
	c.TIME_BLOCK = "@TIME@";
	c.TIMEBLOCK_MAX = 10000000000000;
	c.main = function(getCommand){
		if(getCommand == c.CMD["ADD_TEXT"]){ c.divInputBox.focus();
			if(c.divInputBox.value != ""){ 
				if(c.data.commands.length ==0){c.data.time = 0;}
				if(c.data.time > c.TIMEBLOCK_MAX){c.data.time = c.TIMEBLOCK_MAX;}
				c.data.commands.push(c.divInputBox.value +
					c.TIME_BLOCK + c.data.time);
				var tmpS = ""; for(i in c.keepTextBetweenBlocks){ 
					if(c.divInputBox.value.split(i).length > 1){tmpS +=i + " ";} }
				c.divInputBox.value = tmpS; 
				c.data.time = 0;
				c.data.place = c.data.commands.length;
				c.main(c.CMD["UPDATE_DISP_TEXT"]);
		}	}
		if(getCommand == c.CMD["CLEAR_RECORDING"]){ 
			c.data = JSON.parse(JSON.stringify(c.data_DEFAULT));
			c.dataPlayback_Caught = JSON.parse(JSON.stringify(c.data_DEFAULT));
			c.dataPlayback = JSON.parse(JSON.stringify(c.data_DEFAULT));
			
			c.divDisp.innerHTML = "";
			c.divPlayback.innerHTML = ""; }
		if(getCommand == c.CMD["ADD_FAST"]){ c.divInputBox.focus();
			c.divInputBox.value += c.formatCommands["/fast"];}
		if(getCommand == c.CMD["ADD_NEEDSCLICK"]){ c.divInputBox.focus();
			c.divInputBox.value += c.formatCommands["/needsclick"];}
		if(getCommand == c.CMD["ADD_FASTER"]){ c.divInputBox.focus();
			c.divInputBox.value += c.formatCommands["/realfast"];}
		if(getCommand == c.CMD["MARK_WAKEUP_SCRIPT"]){ c.divInputBox.focus();
			c.divInputBox.value += c.formatCommands["/wakeupscript"];}
		if(getCommand == c.CMD["MARK_SKIP_CLICKING_STARTING_NOW"]){
			c.divInputBox.focus();
			c.divInputBox.value += c.formatCommands["/clickskips"];}
			
		if( getCommand == c.CMD["UPDATE_TIMER"]){
			if(c.data.running){ c.data.time += c.data.timeMultiplier; }
			if(c.dataPlayback.running){
			
				var tmpPauseTimerForClick = false;
				if(c.dataPlayback.place >1){
					if(c.dataPlayback.commands[c.dataPlayback.place-1]
						.split(c.formatCommands['/needsclick']).length >1){
							tmpPauseTimerForClick = true;} }
				if(tmpPauseTimerForClick == false){
					c.dataPlayback.time += c.dataPlayback.timeMultiplier; }
					
				if(c.dataPlayback.time > parseInt(
					c.dataPlayback.commands[c.dataPlayback.place].split( c.TIME_BLOCK)[1]/
					c.dataPlayback.timeMultiplier )){
						c.dataPlayback.time = 0;
						c.dataPlayback.place +=1;
						
						if(c.dataPlayback.commands.length == c.dataPlayback.place){ 
							c.dataPlayback.running = false; }
						c.main( c.CMD["UPDATE_PLAYBACK_TEXT"] );
						return;
				}}	
		}
		
		if( getCommand == c.CMD["UPDATE_PLAYBACK_TEXT"]){
			c.divPlayback.innerHTML = 
				c.updateTextBlock(c.divPlayback.innerHTML, 
				c.dataPlayback.commands.slice(0,c.dataPlayback.place));
			
			c.dataPlayback.timeMultiplier =1;
			
			c.divPlayback.scrollTop = c.divPlayback.scrollHeight;
			if( c.dataPlayback.commands.length == c.dataPlayback.place){return;}
			var tmpCmd =c.dataPlayback.commands[c.dataPlayback.place];
			for(i in c.speeds){
				if(tmpCmd.split(i).length > 1 ){ 
					c.dataPlayback.timeMultiplier = c.speeds[i];}	}
		}
		if( getCommand == c.CMD["UPDATE_DISP_TEXT"]){
			c.divDisp.innerHTML = 
				c.updateTextBlock(c.divDisp.innerHTML,
				c.data.commands.slice(0,c.data.place)); 
			c.divDisp.scrollTop = c.divDisp.scrollHeight;}
			
		if( getCommand == c.CMD["START_PLAYBACK"]){
			c.dataPlayback = JSON.parse(JSON.stringify(c.data));
			c.dataPlayback_Caught = JSON.parse(JSON.stringify(c.data));
			c.dataPlayback.place =0;
			c.dataPlayback.time =0;
			c.dataPlayback_Caught.place = 0;
			c.dataPlayback_Caught.time =0;
			
			c.dataPlayback.timeMultiplier = 1;
			c.dataPlayback.running = true;	}
		if( getCommand == c.CMD["PLAYBACK_PRESS_BUTTON"]){
			if(c.dataPlayback.place ==0){return;}
			var tmpLine = c.dataPlayback.commands[c.dataPlayback.place];
			while(tmpLine.split("/clickskips").length >1 ){
					tmpLine = c.dataPlayback.commands[c.dataPlayback.place];
					c.dataPlayback.commands.splice(c.dataPlayback.place, 1);
					c.dataPlayback.time = 0;
					tmpLine = c.dataPlayback.commands[c.dataPlayback.place]; }
			//this stops timer until click pressed, so add double time during click 
			tmpLine = c.dataPlayback.commands[c.dataPlayback.place-1];
			if(tmpLine.split("/needsclick").length >1 ){
				c.dataPlayback.time += 2*parseInt(
					c.dataPlayback.commands[c.dataPlayback.place].split( c.TIME_BLOCK)[1]);
				return; }	}		
		if( getCommand == c.CMD["PLAYBACK_GOTO_WAKUP_SCRIPT"]){
			var wakupScriptPlace = 0;
			var count =0;
			for(i in c.dataPlayback.commands){ 
				if(c.dataPlayback.commands[count].split("/wakeupscript")
					.length > 1){
						wakupScriptPlace = count; }
				count +=1;	}
			if(wakupScriptPlace >0){
				while(wakupScriptPlace > c.dataPlayback.place){
					c.dataPlayback.commands.splice(c.dataPlayback.place, 1);
					c.dataPlayback.time = 0;
					wakupScriptPlace -=1;
			}	}
		}
		if( getCommand == c.CMD["PLAYBACK_RESET"]){
				c.dataPlayback = JSON.parse( JSON.stringify(c.dataPlayback_Caught)); 
				c.main(getCommand);
				c.CMD["UPDATE_PLAYBACK_TEXT"]; }
				
		if( getCommand == c.CMD["SAVE_FILE"]){ 
			c.divSavedHTML.value = c.saveFile();
			//this needs to be put in 
			}
	}
	c.saveFile = function(){
		c.dataPlayback.place = c.dataPlayback.commands.length;
	
		var js_code = "<script language='javascript'> \n";
		js_code += "var c =JSON.parse(" + 
			"function(){ /" + "****" + 
			JSON.stringify(c, null, " ") +
			"****" + "/}.toString().split('****')[1]"+
			"); \n";
		for(i in c){
			if(typeof c[i] == 'function'){
				js_code += "c." + i + " = "+c[i].toString() + " \n";} }
		
		js_code += "c.settup_controls();";
		js_code += "</scr" + "ipt>";
		var html = "<html></body>@PUT_PLAYBACK_HERE@@PUT_JS_HERE@</body> </html>" 
		
		//RETURN IS FOR TESTING
		return html.split("@PUT_PLAYBACK_HERE@")
			.join(document.getElementById('css').innerHTML 
				+ c.playbackHTML_div_Caught)
			.split('@PUT_JS_HERE@').join( js_code );
	}
</script>

<body>
</html>
